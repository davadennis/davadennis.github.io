<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h2>Dashboard</h2>
        <p id="welcome-message"></p>
        
        <!-- Form Login Hotspot Mikrotik -->
        <form name="login" onsubmit="connectToHotspot(); return false;">
            <label>
                <img class="ico" src="img/user.svg" alt="#">
                <input id="username" type="text" placeholder="Username" required>
            </label>
            <label>
                <img class="ico" src="img/password.svg" alt="#">
                <input id="password" type="password" placeholder="Password" required>
            </label>
            <input type="submit" value="Connect">
        </form>
    </div>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAZ9Dbbsu3oDt4g14ceXYuETPZzyIwb910",
            authDomain: "bank-sampah-19cfe.firebaseapp.com",
            projectId: "bank-sampah-19cfe",
            storageBucket: "bank-sampah-19cfe.appspot.com",
            messagingSenderId: "846385776645",
            appId: "1:846385776645:web:d325c150ed81d8264d746c",
            measurementId: "G-XBJ1S1F04B"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    document.getElementById('welcome-message').innerText = `Halo, ${userData.username}`;
                }
            } else {
                window.location.href = 'index.html'; // Redirect to login page if not logged in
            }
        });

        async function connectToHotspot() {
            // Ambil nilai username dan password dari input form
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Buat objek data untuk dikirim
            const data = {
                username: username,
                password: password
            };

            // Kirim permintaan HTTP POST ke endpoint MikroTik
            try {
                const response = await fetch('http://192.168.77.1/authenticate.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const result = await response.json();

                // Tanggapan dari server MikroTik
                if (result.status === 'success') {
                    alert('Login successful');
                } else {
                    alert('Invalid credentials');
                }
            } catch (error) {
                console.error('There was an error with the fetch operation:', error);
            }
        }
    </script>
</body>
</html>
